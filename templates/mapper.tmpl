
<!DOCTYPE html>
<html>
	<head>
		<title>{{ .title }}</title>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset="utf-8">
		<style>
			html, body {
				height: 100%;
				margin: 0;
				padding: 0;
			}
			#map {
				height: 100%;
			}
			.row {
				width: 100%;
				float: left;
			}
			.row .left {
				float: left;
				margin-right: 0.5em;
			}
			.row .right {
				float: left;
				width: 70%;
				text-align: justify;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<script>
			var INITIAL_MAP_ZOOM = 3;
			var MAP_LEVEL = {
				'COUNTRY': 1,
				'CITY': 2,
				'PLACES': 3,
			};

			var map;
			var infowindow;

			window.currentlyShowing = 0;

			function getCurrentlyShowing() {
				return window.currentlyShowing;
			}

			function setCurrentlyShowing(level) {
				window.currentlyShowing = level;
			}

			function clearAllMarkers(map) {
				map.data.forEach(function(feature) {
					map.data.remove(feature);
				});
			}

			function setMapCenter(map) {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(position) {
						var pos = {
							lat: position.coords.latitude,
							lng: position.coords.longitude
						};

						map.setCenter(pos);
					});
				}
			}

			function showCountries(map) {
				if (getCurrentlyShowing() == MAP_LEVEL['COUNTRY']) {
					return;
				}

				clearAllMarkers(map);
				map.data.loadGeoJson('countries.json');

				map.data.setStyle(function(feature) {
					country = feature.getProperty("country");
					return {
					  icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=' + country + '|FF0000|000000',
					}
				});

				setCurrentlyShowing(MAP_LEVEL['COUNTRY']);
			}

			function showPlaces(map) {
				if (getCurrentlyShowing() == MAP_LEVEL['PLACES']) {
					return;
				}

				clearAllMarkers(map);
				map.data.loadGeoJson('top.json');

				map.data.setStyle(function(feature) {
					return {
						icon: 'https://mt.google.com/vt/icon?psize=20&font=fonts/Roboto-Regular.ttf&color=ff330000&name=icons/spotlight/spotlight-waypoint-a.png&ax=44&ay=48&scale=0.5&text=%E2%80%A2',
					}
				});

				setCurrentlyShowing(MAP_LEVEL['PLACES']);
			}
			
			function initMap() {				
				infoWindow = new google.maps.InfoWindow();
				
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: 0, lng: 0},
				});

				map.addListener('zoom_changed', function(){
					switch(map.getZoom()) {
						case 0:
						case 1:
						case 2:
						case 3:
							showCountries(map);
							break;
						default:
							showPlaces(map);
							break;
					}
				});

				map.setZoom(INITIAL_MAP_ZOOM);
				setMapCenter(map);
			}

			
		</script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?key={{ .key }}&callback=initMap" async defer></script>
	</body>
</html>
